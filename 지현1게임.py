import threading
import time
import random

def play_subway_game(players):
    subway_lines = {
        '1호선': ['인천', '동인천', '도원', '제물포', '도화', '주안', '간석', '동암', '백운', '부평', '부개', '송내', '중동', '부천', '소사', '역곡', '온수', '오류동', '개봉', '구일', '구로', '신도림', '영등포', '신길', '대방', '노량진', '용산', '남영', '서울역', 
                '시청', '종각', '종로3가', '종로5가', '동대문', '동묘앞', '신설동', '제기동', '청량리', '회기', '외대앞', '신이문', '석계', '광운대', '월계', '녹천', '창동', '방학', '도봉', '도봉산', '망월사', '회룡', '의정부', '가능', '녹양', '양주', 
                '덕계', '덕정', '지행', '동두천중앙', '보산', '동두천', '소요산', '가산디지털단지', '독산', '금천구청', '석수', '관악', '안양', '명학', '금정', '군포', '당정', '의왕', '성균관대', '화서', '수원', '세류', '병점', '서동탄', '세마', '오산대', 
                '오산', '진위', '송탄', '서정리', '지제', '평택', '성환', '직산', '두정', '천안', '봉명', '쌍용', '아산', '탕정', '배방', '온양온천', '신창'],
        '2호선': ['시청', '을지로입구', '을지로3가', '을지로4가', '동대문역사문화공원', '신당', '상왕십리', '왕십리', '한양대', '뚝섬', '성수', '건대입구', '구의', '강변', '잠실나루', '잠실', '잠실새내', '종합운동장', '삼성', '선릉', '역삼', '강남', 
                '교대', '서초', '방배', '사당', '낙성대', '서울대입구', '봉천', '신림', '신대방', '구로디지털단지', '대림', '신도림', '문래', '영등포구청', '당산', '합정', '홍대입구', '신촌', '이대', '아현', '충정로', '까치산', '신정네거리', '양천구청', '도림천'],
        '3호선': ['대화', '주엽', '정발산', '마두', '백석', '대곡', '화정', '원당', '원흥', '삼송', '지축', '구파발', '연신내', '불광', '녹번', '홍제', '무악재', '독립문', '경복궁', '안국', '종로3가', '을지로3가', '충무로', '동대입구', '약수', '금호', '옥수', '압구정', 
                '신사', '잠원', '고속터미널', '교대', '남부터미널', '양재', '매봉', '도곡', '대치', '학여울', '대청', '일원', '수서', '가락시장', '경찰병원', '오금'],
        '4호선': ['당고개', '상계', '노원', '창동', '쌍문', '수유', '미아', '미아사거리', '길음', '성신여대입구', '한성대입구', '혜화', '동대문', '동대문역사문화공원', '충무로', '명동', '회현', '서울역', '숙대입구', '삼각지', '신용산', '이촌', '동작', '총신대입구', 
                '사당', '남태령', '선바위', '경마공원', '대공원', '과천', '정부과천청사', '인덕원', '평촌', '범계', '금정', '산본', '수리산', '대야미', '반월', '상록수', '한대앞', '중앙', '고잔', '초지', '안산', '신길온천', '정왕', '오이도'],
        '5호선': ['방화', '개화산', '김포공항', '송정', '마곡', '발산', '우장산', '화곡', '까치산', '신정', '목동', '오목교', '양평', '영등포구청', '영등포시장', '신길', '여의도', '여의나루', '마포', '공덕', '애오개', '충정로', '서대문', '광화문', '종로3가', 
                '을지로4가', '동대문역사문화공원', '청구', '신금호', '행당', '왕십리', '마장', '답십리', '장한평', '군자', '아차산', '광나루', '천호', '강동', '둔촌동', '올림픽공원', '방이', '오금', '개롱', '거여', '마천', '강일', '미사', '하남풍산', 
                '하남시청', '하남검단산', '명일', '고덕', '상일동', '길동', '굽은다리', '명일'],
        '6호선': ['응암', '역촌', '불광', '독바위', '연신내', '구산', '디지털미디어시티', '월드컵경기장', '마포구청', '망원', '합정', '상수', '광흥창', '대흥', '공덕', '효창공원앞', '삼각지', '녹사평', '이태원', '한강진', '버티고개', '약수', '청구', '신당', '동묘앞', '창신', 
                '보문', '안암', '고려대', '월곡', '상월곡', '돌곶이', '석계', '태릉입구', '화랑대', '봉화산', '신내'],
        '7호선': ['장암', '도봉산', '수락산', '마들', '노원', '중계', '하계', '공릉', '태릉입구', '먹골', '중화', '상봉', '면목', '사가정', '용마산', '중곡', '군자', '어린이대공원', '건대입구', '뚝섬유원지', '청담', '강남구청', '학동', '논현', '반포', '고속터미널', 
                '내방', '이수', '남성', '숭실대입구', '상도', '장승배기', '신대방삼거리', '보라매', '신풍', '대림', '가산디지털단지', '철산', '광명사거리', '천왕', '온수', '까치울', '부천종합운동장', '춘의', '신중동', '부천시청', '상동', '삼산체육관', '굴포천', 
                '부평구청', '산곡', '석남'],
        '8호선': ['암사', '천호', '강동구청', '몽촌토성', '잠실', '석촌', '송파', '가락시장', '문정', '장지', '복정', '남위례', '산성', '남한산성입구', '단대오거리', '신흥', '수진', '모란'],
        '9호선': ['개화', '김포공항', '공항시장', '신방화', '마곡나루', '양천향교', '가양', '증미', '등촌', '염창', '신목동', '선유도', '당산', '국회의사당', '여의도', '샛강', '노량진', '노들', '흑석', '동작', '구반포', '신반포', '고속터미널', '사평', '신논현', '언주', 
                '선정릉', '삼성중앙', '봉은사', '종합운동장', '삼전', '석촌', '석촌고분', '중앙보훈병원', '둔촌오륜', '한성백제', '송파나루', '올림픽공원']
    }

    all_stations = set(station for line in subway_lines.values() for station in line)

    print("지하철 게임을 시작합니다!")
    
    # 발회자(첫 번째 플레이어)가 노선 선택
    current_line = random.choice(list(subway_lines.keys()))
    print(f"{players[0][0]}님이 {current_line}을 선택했습니다.")

    used_stations = set()
    current_player_index = 0
    direction = 1  # 1: 정방향, -1: 역방향

    def timer_expired():
        nonlocal timer_expired_flag
        timer_expired_flag = True

    while True:
        current_player = players[current_player_index]
        print(f"\n{current_player[0]}의 차례입니다. (현재 노선: {current_line})")

        timer_expired_flag = False
        timer = threading.Timer(5.0, timer_expired)
        timer.start()

        if current_player[0] == players[0][0]:  # 사용자 차례
            station = input("역 이름을 입력하세요 (제한 시간 5초): ")
        else:  # AI 플레이어 차례
            time.sleep(random.uniform(1, 3))  # AI가 생각하는 시간
            if random.random() < 0.3:  # 30% 확률로 실수
                mistake_type = random.choice(["used", "wrong_line", "non_existent"])
                if mistake_type == "used":
                    station = random.choice(list(used_stations)) if used_stations else random.choice(list(all_stations))
                elif mistake_type == "wrong_line":
                    wrong_lines = [line for line in subway_lines.keys() if line != current_line]
                    wrong_line = random.choice(wrong_lines)
                    station = random.choice(subway_lines[wrong_line])
                else:  # non_existent
                    station = "존재하지 않는 역"
            else:
                station = random.choice([s for s in subway_lines[current_line] if s not in used_stations])
            print(f"{current_player[0]}의 선택: {station}")

        timer.cancel()

        if timer_expired_flag:
            print("시간 초과!")
            return current_player

        if station in used_stations:
            print(f"{station}은 이미 사용된 역입니다.")
            return current_player
        
        if station not in subway_lines[current_line]:
            if station in all_stations:
                print(f"{station}은 {current_line}에 없는 역입니다.")
            else:
                print(f"{station}은 존재하지 않는 역입니다.")
            return current_player

        used_stations.add(station)
        print(f"{current_player[0]}님이 {station}을(를) 선택했습니다.")

        # 다음 플레이어로 넘어가기
        current_player_index = (current_player_index + direction) % len(players)

        # 가끔 방향 변경
        if random.random() < 0.1:  # 10% 확률로 방향 변경
            direction *= -1
            print("진행 방향이 변경되었습니다!")

    return random.choice(players) 